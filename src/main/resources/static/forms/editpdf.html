<form role="form" name="form" enctype="multipart/form-data">
    <button class="btn" id="addSign">Add Sign</button>
    <button class="btn" id="downloadFile">Download</button>
    <button class="btn" id="signFile">Sign File</button>
    <button class="btn" id="addIText">Add Itext</button>
    <button class="btn" id="saveBtn">Save</button>
    <button class="btn" id="fullScreen">Full Screen</button>
    <input type="file" accept="application/pdf"
           cam-variable-name="attachFile"
           cam-variable-type="File"
           cam-max-filesize="10000000" id="fileInput">
    <div id="pdf-container"></div>

    <script src="/pdf-lib/2.6.347_pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = '/pdf-lib/2.6.347_pdf.worker.min.js';</script>
    <script src="/pdf-lib/4.3.0_fabric.min.js"></script>
    <script src="/pdf-lib/pdf_lib.min.js"></script>
    <script src="/tt-camunda-form-module.js"></script>
    <script src="/pdf-lib/mypdf.js"></script>
    <script cam-script type="text/form-script">
        window.camForm = camForm;
        window.inject = inject;
        onInit();
        var pdf = new PDFTQT();
        var pdfEditor = new pdf.PDFEditor();
        var filePdf;
        camFormOnload(() => {
            document.getElementById("fileInput").addEventListener('change', async function () {
                if (this.files[0]) {
                    filePdf = this.files[0];
                    const pdfBytes = await filePdf.arrayBuffer();
                    pdfEditor = new pdf.PDFEditor();
                    await pdfEditor.loadPdf('pdf-container', pdfBytes);
                }
            });
        });
        camFormVariablesFetch(() => {
            console.log(formApi.getVariable('attachFile'));
        })
        camFormSubmit(() => {
            let data = pdfEditor.exportData();
            data = {
                scale: data.scale,
                components: data.components.map(item => {
                    const boundingRect = item.getBoundingRect();
                    debugger;
                    return {
                        _objects: item._objects,
                        objects: item.objects,
                        top: item.top,
                        left: item.left,
                        width: item.width,
                        height: item.height,
                        scaleX: item.scaleX,
                        scaleY: item.scaleY,
                        fill: item.fill,
                        fontSize: item.fontSize,
                        type: item.type,
                        text: item.text,
                        textLines: item.textLines,
                        selectionColor: item.selectionColor,
                        metadata: item.metadata
                    };
                })
            }
            formApi.createVariable('pdfData', 'json', data);
        })
        document.body.querySelector("#fullScreen").addEventListener('click', async function () {
            await pdfEditor.reloadPdf();
        });
        document.body.querySelector("#saveBtn").addEventListener('click', async function () {
            processApi.createOrUpdateFile("attachFile", filePdf, function (rep) {
                console.log("upload file success!");
            });
            $scope.save();
        });

        document.body.querySelector("#addIText").addEventListener('click', function () {
            pdfEditor.addIText();
        });

        document.body.querySelector("#signFile").addEventListener("click", async function () {
            const pdfData = pdfEditor.exportData();
            const formData = new FormData();
            formData.append("file", filePdf);
            formData.append("scale", pdfData.scale);
            formData.append("signatures", new Blob([JSON.stringify(pdfData.components.filter(item => item.type === "group").map(item => {
                return {
                    metadata: item.metadata,
                    scaleX: item.scaleX,
                    scaleY: item.scaleY,
                    height: item.height,
                    width: item.width,
                    left: item.left,
                    top: item.top
                }
            }))], {type: 'application/json'}));

            formData.append("textInputs", new Blob([JSON.stringify(pdfData.components.filter(item => item.type === "i-text").map(item => {
                const boundingRect = item.getBoundingRect();
                return {
                    text: item.text,
                    metadata: item.metadata,
                    scaleX: item.scaleX,
                    scaleY: item.scaleY,
                    fontSize: item.fontSize,
                    lineHeight: item.lineHeight,
                    height: boundingRect.height,
                    width: boundingRect.width,
                    left: boundingRect.left,
                    top: boundingRect.top
                }
            }))], {type: 'application/json'}));

            camHttp({
                url: domainUrl + "/pdf/sign",
                data: formData,
                headers: {"Content-Type": undefined},
                method: "post",
                responseType: 'blob'
            })
                    .then(rep => {
                        const url = URL.createObjectURL(rep.data);
                        window.open(url);
                        const downloadLink = document.createElement('a');

                        downloadLink.href = url;
                        downloadLink.download = "result.pdf";
                        downloadLink.click();
                        URL.revokeObjectURL(url);
                    });
        });

        document.body.querySelector('#addSign').addEventListener('click', () => {
            pdfEditor.addGroup();
        });
        document.body.querySelector('#downloadFile').addEventListener('click', async () => {
            const pdfByte = await pdfEditor.saveAsByte();
            const blob = new Blob([pdfByte], {type: 'application/pdf'});

            // Create a temporary URL for the Blob
            const url = URL.createObjectURL(blob);

            // Create a link element
            const link = document.createElement('a');
            link.href = url;
            link.download = 'test.pdf';

            // Append the link to the document body
            document.body.appendChild(link);

            // Trigger the click event to start the download
            link.click();

            // Clean up by revoking the URL object
            URL.revokeObjectURL(url);
        });
    </script>
</form>