<form role="form" name="form">
    <button class="btn" id="addSign">Add Sign</button>
    <button class="btn" id="downloadFile">Download</button>
    <button class="btn" id="signFile">Sign File</button>
    <button class="btn" id="addIText">Add Text Input</button>
    <div id="pdf-container"></div>

    <script src="/pdf-lib/2.6.347_pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = '/pdf-lib/2.6.347_pdf.worker.min.js';</script>
    <script src="/pdf-lib/4.3.0_fabric.min.js"></script>
    <script src="/pdf-lib/pdf_lib.min.js"></script>
    <script src="/pdf-lib/mypdf.js"></script>
    <script cam-script type="text/form-script">
        var pdf = new PDFTQT();
        var pdfEditor = new pdf.PDFEditor();
        var vm = camForm.variableManager;
        var camHttp;
        var camUri;
        inject(['$http', 'Uri', function ($http, Uri) {
            camHttp = $http;
            camUri = Uri;
        }]);


        camForm.on('form-loaded', async function () {
            var link = location.protocol + "//" + location.host;
            await pdfEditor.loadPdf('pdf-container', link + '/pdf.pdf');
        });
        camForm.on('variables-fetched', function () {

        });
        camForm.on('submit', function (e) {
            submit(e, vm);
        });

        function submit(event, vm) {
            let data = pdfEditor.exportData();
            vm.createVariable({
                name: 'pdfData',
                type: 'json',
                value: data
            });
        }

        document.body.querySelector("#addIText").addEventListener('click', function () {
                pdfEditor.addIText();
        });

        document.body.querySelector("#signFile").addEventListener("click", previewFile);

        function previewFile() {
            const pdfData = pdfEditor.exportData();
            const scale = pdfData.scale;
            const components = pdfData.components;

            // send data to server, to sign and dowload file


            fetch("http://localhost:8080/pdf/sign", {
                method: "POST",
                body: ""
            })
                    .then(rep => rep.arrayBuffer())
                    .then(bytes => {
                        var blob = new Blob([bytes], {type: "application/pdf"});
                        const blobUrl = URL.createObjectURL(blob);
                        window.open(blobUrl);
                    });
        }

        document.body.querySelector('#addSign').addEventListener('click', () => {
            pdfEditor.addGroup();
        });
        document.body.querySelector('#downloadFile').addEventListener('click', async () => {
            const pdfByte = await pdfEditor.saveAsByte();
            console.log(pdfByte);
            const blob = new Blob([pdfByte], {type: 'application/pdf'});

            // Create a temporary URL for the Blob
            const url = URL.createObjectURL(blob);

            // Create a link element
            const link = document.createElement('a');
            link.href = url;
            link.download = 'test.pdf';

            // Append the link to the document body
            document.body.appendChild(link);

            // Trigger the click event to start the download
            link.click();

            // Clean up by revoking the URL object
            URL.revokeObjectURL(url);
        });
    </script>
</form>